#!/usr/bin/env bash

# dd-push-release-branch
#
# push a release branch to remote git repo
#
# author  : stefan schablowski
# contact : stefan.schablowski@desmodyne.com
# created : 2016-06-06


echo
echo 'dd-push-release-branch:'
echo

# -----------------------------------------------------------------------------
# process command line arguments

if [ $# -ne 1 ]
then
    echo "Usage: $(basename "$0") <repository root folder>"
    exit -1
else
    if [ ! -e "$1" ]
    then
        echo "$1: No such file or directory"
        exit -1
    fi
    if [ ! -d "$1" ]
    then
        echo "$1: Not a directory"
        exit -1
    fi
fi

# TODO: prevent processing repo this file is in during development ?
# TODO: verify required executables are available before using them ?
# TODO: script return value when run as Jenkins job ?!?
# TODO: add leading zero to calender week in release name


# -----------------------------------------------------------------------------
# configure script parameters

# absolute path to the root folder of the repository to process
repo_root="$(realpath "$1")"

# release branch prefix; 'release' as per git flow convention
branch_release_prefix='release'


# NOTE: pushd / popd require bash
pushd "${repo_root}" > /dev/null


# -----------------------------------------------------------------------------
# push the release branch

# NOTE: this script expects to be called in the following context:
# dd-release has started a release, updated the project version and created
# release notes; the target repo is on the release branch and there are no
# tags yet; only the release branch needs to be pushed to origin

# TODO: deal with improperly set up remotes not using 'origin':
# git flow heavily relies on that convention:
#   fatal: No configured push destination.
#   Either specify the URL from the command-line or configure a remote repository using
#       git remote add <name> <url>
#   and then push using the remote name
#       git push <name>

# name of the release in progress
# TODO: this assumes there is only one local release branch at a time - which is
# reasonable as git flow refuses to start a release if there is already one
release_name="$(git branch | grep "^[*| ] ${branch_release_prefix}" | cut -d / -f 2)"

if [ -z "${release_name}" ]
then
    echo "Failed to determine name of current release"
    exit -1
fi

# NOTE: 'git push' alone fails with e.g.
# fatal: The current branch release/2016.22 has no upstream branch.
# To push the current branch and set the remote as upstream, use
#     git push --set-upstream origin release/2016.22

# TODO: see dd-upload-artifacts
if [ "$(hostname)" = 'vm-build-nice' ]
then
    # shellcheck disable=SC2034
    SSH_AUTH_SOCK='/home/bob.the.builder/.ssh/ssh_auth_sock'
fi

echo "Push release branch ${branch_release_prefix}/${release_name} to origin:"
git push origin --set-upstream "${branch_release_prefix}/${release_name}"

res="$?"

if [ "${res}" -ne 0 ]
then
    # git push prints its own error messages
    popd > /dev/null
    exit "${res}"
fi


popd > /dev/null


echo
echo 'dd-push-release-branch: success'
echo
