#!/usr/bin/env bash

# dd-verify-user-configuration
#
# verify git configuration for current user
#
# author  : stefan schablowski
# contact : stefan.schablowski@desmodyne.com
# created : 2016-06-16


# -----------------------------------------------------------------------------
# process command line arguments

if [ $# -ne 1 ]
then
    echo "Usage: $(basename "$0") <repository root folder>"
    exit -1
else
    if [ ! -e "$1" ]
    then
        echo "$1: No such file or directory"
        exit -1
    fi
    if [ ! -d "$1" ]
    then
        echo "$1: Not a directory"
        exit -1
    fi
fi


# -----------------------------------------------------------------------------
# configure script parameters

# absolute path to the root folder of the repository to process
repo_root="$(realpath "$1")"

# TODO: establish email address convention:
# email_regex='[a-z\.]@desmodyne.com'

# message displayed to user if verification fails
# NOTE: space between << and 'EOT' messes up atom syntax highlighting
read -r -d '' error_message <<'EOT'
Your name and / or email address do not seem to be configured correctly;
please set them up by adapting the commands below and retry. While you're
at it, you also might want to set your password to be cached for 24 hours:

    git config --global user.name "Your Name"
    git config --global user.email you@example.com
    git config --global credential.helper "cache --timeout=86400"
EOT


# NOTE: pushd / popd require bash
pushd "${repo_root}" > /dev/null


# -----------------------------------------------------------------------------
# verify user configuration

if [ -z "$(git config user.name)" ] || [ -z "$(git config user.email)" ]
then

    echo "${error_message}"
    echo
    popd > /dev/null
    exit -1
fi


popd > /dev/null
